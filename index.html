<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Demo MiniApp</title>
        <script src="https://cdn.marmot-cloud.com/npm/hylid-bridge/2.10.0/index.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    </head>

    <body>
        <div
            class="w-full h-screen flex flex-col items-center gap-4 justify-start p-4 mt-16"
        >
            <button
                class="bg-green-500 text-white px-4 py-2 rounded-md"
                onclick="authenticate()"
            >
                Login
            </button>
            <button
                class="bg-blue-500 text-white px-4 py-2 rounded-md"
                onclick="pay()"
            >
                Pay
            </button>

            <button
                class="bg-orange-500 text-white px-4 py-2 rounded-md"
                onclick="scan()"
            >
                scan QR code
            </button>

            <p class="text-sm text-gray-500">
                Auth Code: <span id="authCode"></span>
            </p>
        </div>

        <script>
            var authCode = "";
            var token = "";

            function authenticate() {
                my.getAuthCode({
                    scopes: ["auth_base", "USER_ID"],
                    success: (res) => {
                        authCode = res.authCode;
                        document.getElementById("authCode").textContent =
                            authCode;

                        fetch(
                            "https://its.mouamle.space/api/auth-with-superQi",
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    token: authCode,
                                }),
                            }
                        )
                            .then((res) => res.json())
                            .then((data) => {
                                token = data.token;
                                my.alert({
                                    content: "Login successful",
                                });
                            })
                            .catch((err) => {
                                let errorDetails = "";
                                if (err && typeof err === "object") {
                                    errorDetails = JSON.stringify(err, null, 2);
                                } else {
                                    errorDetails = String(err);
                                }
                                my.alert({
                                    content: "Error: " + errorDetails,
                                });
                            });
                    },
                    fail: (res) => {
                        console.log(res.authErrorScopes);
                    },
                });
            }

            function pay() {
                fetch("https://its.mouamle.space/api/payment", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: token,
                    },
                })
                    .then((res) => res.json())
                    .then((data) => {
                        my.tradePay({
                            paymentUrl: data.url,
                            success: (res) => {
                                my.alert({
                                    content: "Payment successful",
                                });
                            },
                        });
                    })
                    .catch((err) => {
                        my.alert({
                            content: "Payment failed",
                        });
                    });
            }

            function copyAuthCode() {
                navigator.clipboard.writeText(authCode);
            }

            Page({
                scan() {
                    my.scan({
                        type: "qr",
                        success: (res) => {
                            my.alert({ title: res.code });
                        },
                    });
                },
            });
        </script>
    </body>
</html>
